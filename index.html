<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metta Mandala - Meditation Practice</title>
    <style>
        /* Color System */
        :root {
            --compassion-500: #F6C5D2; /* Light Pink */
            --compassion-300: #F9D5DF;
            --compassion-700: #EFAABB;

            --wisdom-500: #FFFFFF;     /* White */

            --calm-surface: #F2F4F7;   /* Canvas base */
            --ink-900: #1F2937;        /* Text / Stroke */
            --outline-300: #D0D5DD;    /* Dividers */
            --focus-ring: #94A3B8;     /* Breath ring */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Manrope', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--calm-surface);
            color: var(--ink-900);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4 {
            font-weight: 400;
            margin-bottom: 1rem;
        }
        
        p {
            margin-bottom: 1rem;
        }
        
        button {
            cursor: pointer;
            background: var(--compassion-500);
            color: var(--ink-900);
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background: var(--compassion-700);
            transform: translateY(-1px);
        }

        button.secondary {
            background: transparent;
            color: var(--compassion-500);
            border: 1px solid var(--compassion-500);
        }

        button.secondary:hover {
            background: var(--compassion-300);
            color: var(--ink-900);
        }

        button.primary {
            background: var(--compassion-500);
            color: var(--ink-900);
            font-weight: 500;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Header Styles */
        header {
            padding: 20px 0;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .logo h1 {
            font-size: 28px;
            margin: 0;
            color: var(--compassion-500);
        }
        
        .logo svg {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            fill: var(--compassion-500);
        }

        /* Main Screen Styles */
        .main-screen {
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }
        
        .welcome-message {
            max-width: 600px;
            margin-bottom: 40px;
        }
        
        .welcome-message h2 {
            font-size: 32px;
            margin-bottom: 20px;
            color: var(--compassion-500);
        }
        
        .welcome-message p {
            font-size: 18px;
            color: var(--ink-900);
            margin-bottom: 20px;
        }
        
        .main-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 400px;
        }
        
        .action-button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-button svg {
            margin-right: 10px;
            width: 24px;
            height: 24px;
        }

        /* Canvas Container */
        .canvas-wrap {
            background: var(--calm-surface);
            border: 1px solid var(--outline-300);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        canvas {
            display: block;
            background: var(--calm-surface);
            border-radius: 8px;
            width: 100%;
            height: 100%;
        }

        /* Color Swatches */
        .swatches {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .swatch {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .swatch:hover {
            transform: scale(1.1);
        }

        .swatch.selected {
            border-color: var(--compassion-700);
            transform: scale(1.1);
        }

        .swatch.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--ink-900);
            font-weight: bold;
            font-size: 18px;
        }

        /* Focus View */
        .focus-view {
            text-align: center;
            padding: 40px 20px;
        }

        .hint {
            margin-top: 20px;
            color: var(--ink-900);
            font-style: italic;
            font-size: 16px;
        }

        /* Create View */
        .create-view {
            text-align: center;
            padding: 20px;
        }

        /* Bless View */
        .bless {
            text-align: center;
            padding: 40px 20px;
        }

        .targets {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .chip {
            padding: 12px 24px;
            border-radius: 25px;
            background: white;
            border: 2px solid var(--outline-300);
            color: var(--ink-900);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chip:hover, .chip.selected {
            border-color: var(--compassion-500);
            background: var(--compassion-300);
        }

        .phrases {
            list-style: none;
            margin: 30px 0;
            padding: 0;
        }

        .phrases li {
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--compassion-500);
            text-align: left;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Dedicate View */
        .dedicate {
            text-align: center;
            padding: 40px 20px;
        }

        .dedicate p {
            font-size: 18px;
            margin-bottom: 30px;
            color: var(--ink-900);
        }

        /* River View */
        .river {
            padding: 40px 20px;
            text-align: center;
        }

        .river h3 {
            color: var(--compassion-500);
            margin-bottom: 30px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .card figcaption {
            color: var(--ink-900);
            font-weight: 500;
        }

        /* Reflection View */
        .reflection-view {
            padding: 40px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .reflection-view form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .reflection-view label {
            display: block;
            margin: 20px 0 10px;
            color: var(--ink-900);
            font-weight: 500;
        }

        .reflection-view input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .reflection-view textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--outline-300);
            border-radius: 8px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .breath, .dissolve { animation: none !important; }
            button:hover { transform: none; }
            .swatch:hover { transform: none; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 15px; }
            .swatches { gap: 10px; }
            .swatch { width: 40px; height: 40px; }
            .targets { gap: 10px; }
            .chip { padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                </svg>
                <h1>Metta Mandala</h1>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="container">
        <!-- Home Screen -->
        <section class="main-screen" id="homeView">
            <div class="welcome-message">
                <h2>Welcome to Metta Mandala</h2>
                <p>Create mandalas of compassion and kindness. Each circle extends your love from yourself to all beings, creating a shared experience of peace and connection.</p>
            </div>
            <div class="main-actions">
                <button class="action-button primary" id="startPracticeBtn">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Start Practice
                </button>
            </div>
        </section>

        <!-- Focus View -->
        <section class="focus-view" id="focusView" style="display: none;">
            <h2>Focus Your Mind</h2>
            <div class="canvas-wrap" style="height: 320px;">
                <canvas id="focusCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
            <p class="hint">If the mind wanders, gently return to the circle.</p>
        </section>

        <!-- Create View -->
        <section class="create-view" id="createView" style="display: none;">
            <h2>Create Your Mandala</h2>
            <div id="colorSwatches" class="swatches"></div>
            <div class="canvas-wrap" style="height: 360px;">
                <canvas id="createCanvas" style="width: 100%; height: 100%;"></canvas>
            </div>
            <div class="navigation">
                <button class="secondary" id="clearCanvasBtn">Clear</button>
                <button class="primary" id="nextToBlessBtn">Next (Bless)</button>
            </div>
        </section>

        <!-- Bless View -->
        <section class="bless" id="blessView" style="display: none;">
            <h3>Select a target</h3>
            <div class="targets" id="targetSelection"></div>
            <ul class="phrases" id="mettaPhrases"></ul>
            <button class="primary" id="nextToDedicateBtn">Send (Dedicate)</button>
        </section>

        <!-- Dedicate View -->
        <section class="dedicate" id="dedicateView" style="display: none;">
            <p>Press and hold to send your intention as a blessing.</p>
            <button class="primary" id="dedicateButton">Send (Dedicate)</button>
        </section>

        <!-- River View -->
        <section class="river" id="riverView" style="display: none;">
            <h3>River of Compassion</h3>
            <div class="grid" id="riverGrid"></div>
        </section>

        <!-- Reflection View -->
        <section class="reflection-view" id="reflectionView" style="display: none;">
            <h2>How do you feel?</h2>
            <form id="reflectionForm">
                <label>How calm do you feel now? <span id="calmValue">0</span></label>
                <input type="range" min="0" max="5" value="0" id="calmSlider" />
                
                <label>How compassionate do you feel now? <span id="compassionValue">0</span></label>
                <input type="range" min="0" max="5" value="0" id="compassionSlider" />
                
                <label>Any note (optional)</label>
                <textarea id="noteInput" placeholder="Share your thoughts..."></textarea>
                
                <button type="submit" class="primary">Submit & Exit</button>
            </form>
        </section>
    </div>

    <script>
        // Color Palette Constants
        const PALETTE = [
            { key: 'compassion', hex: '#F6C5D2', label: 'Compassion (Light Pink)' },
            { key: 'wisdom', hex: '#FFFFFF', label: 'Wisdom (White)' },
            { key: 'compassionLight', hex: '#F9D5DF', label: 'Compassion Light', hidden: true },
            { key: 'compassionDeep', hex: '#EFAABB', label: 'Compassion Deep', hidden: true },
        ];

        const COLORS = Object.fromEntries(PALETTE.map(c => [c.key, c.hex]));

        // Flow State Management
        const FLOW = ['FOCUS', 'CREATE', 'BLESS', 'DEDICATE', 'DISSOLVE', 'RIVER', 'REFLECTION'];
        let currentStep = 'HOME';
        let currentColor = '#F6C5D2';
        let selectedTarget = null;
        let sessionData = {
            id: crypto.randomUUID(),
            startedAt: Date.now(),
            steps: {},
            colorsUsed: {},
            target: null,
            shareToRiver: false,
            selfReport: null
        };

        // DOM Elements
        const views = {
            home: document.getElementById('homeView'),
            focus: document.getElementById('focusView'),
            create: document.getElementById('createView'),
            bless: document.getElementById('blessView'),
            dedicate: document.getElementById('dedicateView'),
            river: document.getElementById('riverView'),
            reflection: document.getElementById('reflectionView')
        };

        // Canvas Elements
        const focusCanvas = document.getElementById('focusCanvas');
        const createCanvas = document.getElementById('createCanvas');

        // Event Listeners
        document.getElementById('startPracticeBtn').addEventListener('click', () => goToStep('FOCUS'));
        document.getElementById('nextToBlessBtn').addEventListener('click', () => goToStep('BLESS'));
        document.getElementById('nextToDedicateBtn').addEventListener('click', () => goToStep('DEDICATE'));
        document.getElementById('clearCanvasBtn').addEventListener('click', clearCanvas);
        document.getElementById('dedicateButton').addEventListener('click', handleDedicate);
        document.getElementById('reflectionForm').addEventListener('submit', handleReflectionSubmit);

        // Slider Event Listeners
        document.getElementById('calmSlider').addEventListener('input', (e) => {
            document.getElementById('calmValue').textContent = e.target.value;
        });
        document.getElementById('compassionSlider').addEventListener('input', (e) => {
            document.getElementById('compassionValue').textContent = e.target.value;
        });

        // Navigation Functions
        function goToStep(step) {
            markStepEnd(currentStep);
            currentStep = step;
            markStepStart(currentStep);
            
            // Hide all views
            Object.values(views).forEach(view => view.style.display = 'none');
            
            // Show current view
            switch(step) {
                case 'HOME':
                    views.home.style.display = 'flex';
                    break;
                case 'FOCUS':
                    views.focus.style.display = 'block';
                    startFocusSession();
                    break;
                case 'CREATE':
                    views.create.style.display = 'block';
                    setupCreateView();
                    break;
                case 'BLESS':
                    views.bless.style.display = 'block';
                    setupBlessView();
                    break;
                case 'DEDICATE':
                    views.dedicate.style.display = 'block';
                    break;
                case 'RIVER':
                    views.river.style.display = 'block';
                    setupRiverView();
                    break;
                case 'REFLECTION':
                    views.reflection.style.display = 'block';
                    break;
            }
        }

        // Focus View Functions
        function startFocusSession() {
            const canvas = focusCanvas;
            const ctx = canvas.getContext('2d');
            const durationMs = 90000; // 90 seconds
            
            // Set canvas size
            canvas.width = canvas.clientWidth * devicePixelRatio;
            canvas.height = canvas.clientHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            let start = performance.now();
            
            function draw(t) {
                const p = Math.min(1, (t - start) / durationMs);
                const w = canvas.clientWidth;
                const h = canvas.clientHeight;
                
                ctx.clearRect(0, 0, w, h);
                
                // Breathing circle
                const center = { x: w / 2, y: h / 2 };
                const baseR = Math.min(w, h) * 0.25;
                const breathe = (Math.sin(t / 1000) + 1) / 2; // 0..1
                const r = baseR * (0.92 + 0.08 * breathe);
                
                // Draw breathing circle
                ctx.beginPath();
                ctx.arc(center.x, center.y, r, 0, Math.PI * 2);
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--focus-ring');
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw mandala skeleton (cross and diagonals)
                ctx.strokeStyle = 'rgba(148,163,184,0.35)';
                ctx.lineWidth = 1;
                [0, Math.PI/2, Math.PI/4, 3*Math.PI/4].forEach(a => {
                    ctx.beginPath();
                    ctx.moveTo(center.x - Math.cos(a) * r, center.y - Math.sin(a) * r);
                    ctx.lineTo(center.x + Math.cos(a) * r, center.y + Math.sin(a) * r);
                    ctx.stroke();
                });
                
                if (p < 1) {
                    requestAnimationFrame(draw);
                } else {
                    goToStep('CREATE');
                }
            }
            
            requestAnimationFrame(draw);
        }

        // Create View Functions
        function setupCreateView() {
            // Setup color swatches
            const colorSwatches = document.getElementById('colorSwatches');
            colorSwatches.innerHTML = '';
            
            PALETTE.filter(c => !c.hidden).forEach(color => {
                const swatch = document.createElement('button');
                swatch.className = `swatch ${currentColor === color.hex ? 'selected' : ''}`;
                swatch.style.background = color.hex;
                swatch.style.border = color.key === 'wisdom' ? '1px solid var(--outline-300)' : 'none';
                swatch.setAttribute('aria-label', color.label);
                swatch.setAttribute('role', 'radio');
                swatch.setAttribute('aria-checked', currentColor === color.hex);
                
                swatch.addEventListener('click', () => {
                    currentColor = color.hex;
                    document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                    countColor(color.hex);
                });
                
                colorSwatches.appendChild(swatch);
            });
            
            // Setup canvas
            const canvas = createCanvas;
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.clientWidth * devicePixelRatio;
            canvas.height = canvas.clientHeight * devicePixelRatio;
            ctx.scale(devicePixelRatio, devicePixelRatio);
            
            // Initialize drawing
            let isDrawing = false;
            let lastPoint = null;
            
            function drawSymmetric(x, y, centerX, centerY, folds = 4) {
                const angleStep = (Math.PI * 2) / folds;
                for (let i = 0; i < folds; i++) {
                    const a = i * angleStep;
                    const dx = x - centerX, dy = y - centerY;
                    const rx = dx * Math.cos(a) - dy * Math.sin(a);
                    const ry = dx * Math.sin(a) + dy * Math.cos(a);
                    ctx.beginPath();
                    ctx.arc(centerX + rx, centerY + ry, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            function strokeWithVisibility(color, lineWidth = 2) {
                ctx.lineWidth = lineWidth;
                ctx.strokeStyle = color;
                if (color.toUpperCase() === '#FFFFFF') {
                    ctx.shadowColor = 'rgba(0,0,0,0.18)';
                    ctx.shadowBlur = 2;
                } else {
                    ctx.shadowBlur = 0;
                }
            }
            
            // Mouse/Touch events
            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                lastPoint = { x, y };
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (lastPoint) {
                    ctx.fillStyle = currentColor;
                    drawSymmetric(x, y, canvas.clientWidth / 2, canvas.clientHeight / 2, 4);
                    countColor(currentColor);
                }
                
                lastPoint = { x, y };
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            // Add event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
                }
            });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    draw({ clientX: touch.clientX, clientY: touch.clientY });
                }
            });
            
            canvas.addEventListener('touchend', stopDrawing);
            
            // Initialize shadow parameters
            strokeWithVisibility('#FFFFFF', 1);
        }

        function clearCanvas() {
            const canvas = createCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Bless View Functions
        function setupBlessView() {
            const targets = [
                { key: 'self', label: 'Self' },
                { key: 'loved', label: 'Loved one' }
            ];
            
            const mettaPhrases = [
                'May you be safe.',
                'May you be happy.',
                'May you be healthy.',
                'May you live with ease.'
            ];
            
            // Setup target selection
            const targetSelection = document.getElementById('targetSelection');
            targetSelection.innerHTML = '';
            
            targets.forEach(target => {
                const chip = document.createElement('button');
                chip.className = 'chip';
                chip.textContent = target.label;
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
                    chip.classList.add('selected');
                    selectedTarget = target.key;
                    sessionData.target = target.key;
                });
                targetSelection.appendChild(chip);
            });
            
            // Setup metta phrases
            const mettaPhrasesEl = document.getElementById('mettaPhrases');
            mettaPhrasesEl.innerHTML = '';
            
            mettaPhrases.forEach(phrase => {
                const li = document.createElement('li');
                li.textContent = phrase;
                mettaPhrasesEl.appendChild(li);
            });
        }

        // Dedicate Functions
        function handleDedicate() {
            // Long press simulation for now
            let pressTimer = setTimeout(() => {
                // Play chime sound (placeholder)
                console.log('Chime sound 1');
                
                // Start dissolve animation
                dissolve(createCanvas, () => {
                    console.log('Chime sound 2');
                    goToStep('RIVER');
                });
            }, 1000);
            
            // Reset timer on release
            const resetTimer = () => {
                clearTimeout(pressTimer);
            };
            
            document.addEventListener('mouseup', resetTimer, { once: true });
            document.addEventListener('touchend', resetTimer, { once: true });
        }

        function dissolve(canvas, onDone, ms = 1200) {
            const ctx = canvas.getContext('2d');
            let start = performance.now();
            const w = canvas.clientWidth;
            const h = canvas.clientHeight;
            
            // Create image data for dissolve effect
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            function draw(t) {
                const p = Math.min(1, (t - start) / ms);
                
                ctx.clearRect(0, 0, w, h);
                ctx.globalAlpha = 1 - p;
                
                // Slight scale effect
                const scale = 1 + p * 0.05;
                ctx.setTransform(scale, 0, 0, scale, -w * 0.025, -h * 0.025);
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.globalAlpha = 1;
                
                if (p < 1) {
                    requestAnimationFrame(draw);
                } else {
                    onDone();
                }
            }
            
            requestAnimationFrame(draw);
        }

        // River View Functions
        function setupRiverView() {
            const riverGrid = document.getElementById('riverGrid');
            riverGrid.innerHTML = '';
            
            // Add user's mandala
            const userCard = document.createElement('figure');
            userCard.className = 'card';
            
            const userImg = document.createElement('img');
            userImg.src = createCanvas.toDataURL();
            userImg.alt = 'Your mandala (sent)';
            
            const userCaption = document.createElement('figcaption');
            userCaption.textContent = 'Your blessing';
            
            userCard.appendChild(userImg);
            userCard.appendChild(userCaption);
            riverGrid.appendChild(userCard);
            
            // Add sample anonymous mandalas
            const sampleMandalas = [
                { location: 'Anonymous', message: 'May peace flow through all beings' },
                { location: 'Anonymous', message: 'Sending healing energy' },
                { location: 'Anonymous', message: 'May all find inner light' }
            ];
            
            sampleMandalas.forEach(mandala => {
                const card = document.createElement('figure');
                card.className = 'card';
                
                const img = document.createElement('div');
                img.style.width = '100%';
                img.style.height = '150px';
                img.style.background = `linear-gradient(45deg, ${PALETTE[Math.floor(Math.random() * PALETTE.length)].hex}, ${PALETTE[Math.floor(Math.random() * PALETTE.length)].hex})`;
                img.style.borderRadius = '8px';
                
                const caption = document.createElement('figcaption');
                caption.textContent = mandala.message;
                
                card.appendChild(img);
                card.appendChild(caption);
                riverGrid.appendChild(card);
            });
            
            // Auto-advance to reflection after 3 seconds
            setTimeout(() => {
                goToStep('REFLECTION');
            }, 3000);
        }

        // Reflection Functions
        function handleReflectionSubmit(e) {
            e.preventDefault();
            
            const calm = parseInt(document.getElementById('calmSlider').value);
            const compassion = parseInt(document.getElementById('compassionSlider').value);
            const note = document.getElementById('noteInput').value;
            
            sessionData.selfReport = { calm, compassion, note };
            
            // Save session data
            save();
            
            // Show completion message and return to home
            alert('Thank you for your practice. Your session has been recorded.');
            goToStep('HOME');
        }

        // Analytics Functions
        function markStepStart(step) {
            sessionData.steps[step] = { t0: performance.now() };
        }

        function markStepEnd(step) {
            if (sessionData.steps[step]) {
                sessionData.steps[step].t1 = performance.now();
            }
        }

        function countColor(hex) {
            sessionData.colorsUsed[hex] = (sessionData.colorsUsed[hex] || 0) + 1;
        }

        function save() {
            localStorage.setItem(`metta:${sessionData.id}`, JSON.stringify(sessionData));
            console.log('Session saved:', sessionData);
        }

        // Initialize
        window.addEventListener('load', () => {
            goToStep('HOME');
        });
    </script>
</body>
</html>
